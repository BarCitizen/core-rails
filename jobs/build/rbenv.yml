---
- name: Install RBENV Pre-Dependencies
  ansible.builtin.apt:
    state: latest
    pkg: 
      - autoconf 
      - patch 
      - build-essential 
      - rustc 
      - libssl-dev 
      - libyaml-dev 
      - libreadline6-dev 
      - zlib1g-dev 
      - libgmp-dev 
      - libncurses5-dev 
      - libffi-dev 
      - libgdbm6 
      - libgdbm-dev 
      - libdb-dev 
      - uuid-dev
- name: Setup user bashrc
  ansible.builtin.lineinfile:
    path: "/{{ run.user }}/.bashrc"
    line: "{{ item }}"
  loop:
    - eval \"$(rbenv init -)\"
- name: Git RBENV
  ansible.builtin.git:
    repo: 'https://github.com/rbenv/rbenv.git'
    single_branch: yes
    version: master
    dest: "{{ rbenv.dir }}"
- name: Get Ruby Build Plugin
  ansible.builtin.git:
    repo: https://github.com/rbenv/ruby-build.git 
    dest: "{{ rbenv.dir }}/plugins/ruby-build"
    single_branch: yes
    version: master
- name: Setup symlinks for rbenv
  ansible.builtin.file:
    src: "{{ rbenv.dir }}/libexec/rbenv"
    dest: /usr/local/bin/rbenv
    mode: "0555"
    state: link
- name: Setup symlinks for rbenv to local user
  ansible.builtin.file:
    src: "{{ rbenv.dir }}"
    dest: "/home/{{ run.user }}/.rbenv"
    mode: "0555"
    state: link
    owner: "{{ run.user }}"
    group: "{{ run.user }}"
  when: not run.user == "root"
- name: Setup symlinks for rbenv to root
  ansible.builtin.file:
    src: "{{ rbenv.dir }}"
    dest: "/root/.rbenv"
    mode: "0555"
    state: link
  when: run.user == "root"
