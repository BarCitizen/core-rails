---
- name: Make sure we have everything for ruby
  apt:
    pkg:
      - libssl-dev
      - libreadline-dev 
      - zlib1g-dev 
      - autoconf 
      - bison 
      - build-essential 
      - libyaml-dev 
      - libreadline-dev 
      - libncurses5-dev 
      - libffi-dev 
      - libgdbm-dev
    state: latest
- name: Drop setup script
  ansible.builtin.template:
    src: "{{ playbook_dir }}/templates/ruby-setup.j2"
    dest: "/usr/local/bin/ruby-setup"
    mode: "0555"
- name: try to install using rbenv
  block:
    - name: Install Ruby via RBENV
      ansible.builtin.shell:
        cmd: |
          rbenv install {{ rbenv.version}} 
          rbenv global {{ rbenv.version}}
      args:
        executable: /bin/bash
  rescue:
    - name: Install Ruby using apt
      ansible.builtin.apt:
        pkg:
          - ruby
          - rubyenv
          - ruby-rails
- name: Turn off docs
  ansible.builtin.lineinfile:
    path: /root/.gemrc
    line: "gem: --no-document"
- name: Turn off docs
  ansible.builtin.lineinfile:
    path: "/home/{{ run.user }}/.gemrc"
    line: "gem: --no-document"
  when: not run.user == "root"
- name: Install Gems
  shell: |
    gem install bundler
    gem install rails -v {{ rails.version }}
